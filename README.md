# ML Fraud Detection Service

Сервис для автоматического обнаружения мошеннических транзакций в режиме батчевого скоринга. Обрабатывает CSV-файлы из указанной директории с использованием предобученной CatBoost модели.

## Архитектура решения

```
├── .gitignore
├── Dockerfile
├── README.md
├── app/
│   └── app.py              # Ядро сервиса с обработчиком файлов
├── models/
│   └── my_catboost.cbm     # Сериализованная модель CatBoost
├── src/
│   ├── preprocessing.py    # Пайплайн обработки данных
│   └── scorer.py           # Модуль прогнозирования + bonus outputs
├── train_data/
│   └── train.csv           # Данные для обучения (скачать из соревнования)
├── input/                  # Директория для загрузки файлов на скоринг
└── output/                 # Директория с результатами скоринга
```

## Выходные файлы

Сервис генерирует следующие файлы в директории `./output`:

| Файл | Описание |
|------|----------|
| `predictions_*.csv` | Предсказания в формате sample_submission (index, prediction) |
| `feature_importances.json` | **[BONUS]** Топ-5 важнейших признаков модели |
| `score_distribution_*.png` | **[BONUS]** График плотности распределения скоров |

### Пример feature_importances.json

```json
{
  "feature_1": 45.23,
  "feature_2": 32.15,
  "feature_3": 18.42,
  "feature_4": 12.08,
  "feature_5": 9.56
}
```

### Пример score_distribution.png

График плотности распределения вероятностей мошенничества с отметками среднего, медианы и порога классификации.

## Пайплайн обработки данных

1. **Временные признаки**: час, день недели, месяц, день месяца, год
2. **Геопространственные расчеты**: расстояние между клиентом и мерчантом (формула гаверсинусов)
3. **Категориальные переменные**: группировка редких категорий + mean-encoding
4. **Числовые признаки**: импутация средними + логарифмирование

## Быстрый старт

### Требования

- Docker 20.10+
- ~2 ГБ свободного места

### 1. Подготовка данных

```bash
# Скачайте train.csv из соревнования и поместите в train_data/
# https://www.kaggle.com/competitions/teta-ml-1-2025
cp /path/to/train.csv ./train_data/

# Скачайте модель из шаблона или обучите свою
cp /path/to/my_catboost.cbm ./models/
```

### 2. Сборка образа

```bash
docker build -t fraud-detector .
```

### 3. Запуск контейнера

```bash
docker run -it --rm \
    -v $(pwd)/input:/app/input \
    -v $(pwd)/output:/app/output \
    fraud-detector
```

### 4. Скоринг данных

1. Дождитесь сообщения в логах: `File observer started`
2. Скопируйте `test.csv` в директорию `./input/`
3. Дождитесь завершения обработки (в логах появится имя выходного файла)
4. Результаты будут в `./output/`:
   - `predictions_*.csv` — предсказания
   - `feature_importances.json` — важность признаков
   - `score_distribution_*.png` — график распределения скоров

## Модельный слой

- **Алгоритм**: CatBoost Classifier
- **Порог классификации**: 0.98
- **Inference**: CPU-only

## Troubleshooting

**"FileNotFoundError: train.csv"**
- Убедитесь, что `train.csv` находится в директории `./train_data/`

**"FileNotFoundError: my_catboost.cbm"**
- Скопируйте файл модели в директорию `./models/`

**Сервис не видит новые файлы**
- Убедитесь, что файл имеет расширение `.csv`
- Проверьте, что директория `./input/` правильно примонтирована

---

*Создано для курса MLOps HSE 2025*
